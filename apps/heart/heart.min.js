var correlator=function(){var bin=atob("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAt6fBHKk19RAAg1fgAgAcmqPEHAYZGb/AATAApC0ZCRti/AfGAA0/wWwkAJK8Yl/gEoO8YP3nH6woHAvEBChtKCuoCAgAqA/EBChhLuL8C8f8yCuoDA7y/YvB/AgEyACu+vwPx/zNj8H8DATO58QEJB/sHRNrRZEW8vzBGpEYBNqZFuL+mRiUuAfH/McXRCUt7RMP4hMDD+IjgKLEoI1hDTvZgI5P78PC96PCHfwAAgGr////g/v//Akt7RNP4hABwRwC/tv7//wJLe0TT+IgAcEcAv6b+//8JSXlEC2jKGBBxWhwFSxNAACu+vwPx/zNj8H8DATMLYHBHAL9/AACAlv7//w==");
return{put:E.nativeCall(357,"void(int)",bin),Cmax:E.nativeCall(341,"int(void)",bin),Cmin:E.nativeCall(325,"int(void)",bin),bpm:E.nativeCall(141,"int(void)",bin)}}();var avgMedFilter=function(){var bin=atob("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcSnpEMLUTaALrgwEBM0hgByGT+/HxwevBAVsaibATYAGoACMRHVH4IxBA+CMQATMHK/fRaUYAIgEyUfgEXxNGBysL0Qcq99EEmwOYGEQFmwNEAyCT+/DwCbAwvVD4I0ClQsG/DWhA+CNQDGAlRgEz5ucAv9r///8=");return{filter:E.nativeCall(33,"int(int)",bin)}}();
var medianFilter=function(){var bin=atob("BQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAACFJeUT4tQtomgAKMiLwBwIAr63rAg1KaAHrggUBMqhgkvvz8AP7ECIYSEpgbEYAInhEmkIH2gDxCAFR+CIQRPgiEAEy9ecSSnpEACHS+CTAIh9hRRPcUvgEbwExFUYIRphC9tpV+ATvdkXEvxZoLmAA8QEAxL/C+ADgdkbw51T4LAC9Rvi9AL/S////pP///4z///8=");return{filter:E.nativeCall(41,"int(int)",bin)}}();
var lpfFilter=function(){var bin=atob("AAAAAAAAAACBeO09gXhtPoF47T0dwDi/dfE9PhNLB+4QCntE0+0AatPtBVqT7QFq0+0GesPtAWq47sd6pe7metPtAlqn7sZ60+0DeoPtAHpm7qd65+4letPtBFrm7iV6/e7nehfukApwRwC/2v///w==");return{filter:E.nativeCall(29,"int(int)",bin)}}();var hpfFilter=function(){var bin=atob("AAAAAAAAAAAAzl4/AM7evwDOXj+xpNy/mO5BPxNLB+4QCntE0+0AatPtBVqT7QFq0+0GesPtAWq47sd6pe7metPtAlqn7sZ60+0DeoPtAHpm7qd65+4letPtBFrm7iV6/e7nehfukApwRwC/2v///w==");return{filter:E.nativeCall(29,"int(int)",bin)}}();
var agcFilter=function(){var bin=atob("AACgQcjSgz91k3g/AAAAQIDq4HIeS6Lr4HIH7hAqe0S47sd60+0AerTu53rx7hD6zL+T7QF6k+0CehZLZ+6HegfuEAp7RPjux2qT7QN6w+0Aeifuh2r07sZq8e4Q+hXcJ+5nevTux2rx7hD6DtRkI0NDB+4QOnfup3r47sdqhu6nev3ux3oX7pAKcEcAIHBH3v///7j///8=");return{filter:E.nativeCall(17,"int(int)",bin)}}();
var pulseDetector=function(){var bin=atob("AAAAAAAAAAAUAAAA7P///xZKekQTeOuxU2iDQgHakGAe4B3d0WiTaFsaFTtA9qIxi0JP8AABjL8AIwEj0WARcAtKekRRaIhCC90AIZFgASERcAbgU2iYQgDa0GAAI+/nACMESnpEUGAYRnBH6v///7r///+Y////");return{isBeat:E.nativeCall(17,"int(int)",bin)}}();
var HRS={writeByte:function(a,d){wOSI2C.writeTo(68,a,d)},readByte:function(a){wOSI2C.writeTo(68,a);return wOSI2C.readFrom(68,1)[0]},enable:function(){HRS.writeByte(23,16);HRS.writeByte(22,120);HRS.writeByte(1,224);HRS.writeByte(12,110)},disable:function(){HRS.writeByte(1,8);HRS.writeByte(2,128);HRS.writeByte(12,78);HRS.writeByte(22,136);HRS.writeByte(12,34);HRS.writeByte(1,240);HRS.writeByte(12,2);HRS.writeByte(12,34);HRS.writeByte(1,240);HRS.writeByte(12,2);HRS.writeByte(12,34);HRS.writeByte(1,240);
HRS.writeByte(12,2);HRS.writeByte(12,34);HRS.writeByte(1,240);HRS.writeByte(12,2)},read:function(){var m=HRS.readByte(9);var h=HRS.readByte(10);var l=HRS.readByte(15);return m<<8|(h&15)<<4|l&15}};Bangle.setLCDTimeout(300);var x=0;var lasty=239;var lastPeak=0;var interval;var bpminterval;var f1=hpfFilter.filter;var f2=medianFilter.filter;var f3=agcFilter.filter;var f4=lpfFilter.filter;var bf=avgMedFilter.filter;var det=pulseDetector.isBeat;var put=correlator.put;
function doread(){var v=f4(f3(f2(f1(HRS.read()))));v=139-v;v=v>239?239:v<40?40:v;put(v);if(det(v)){var peakTime=Date.now();var bpm=Math.floor(6E4/(peakTime-lastPeak));if(bpm>0&&bpm<200){bpm=bf(bpm);g.setColor(-1).setFontAlign(-1,-1).drawString(" BPM: "+bpm+" ",120,20,true)}lastPeak=peakTime}g.setColor(0);g.fillRect(x,40,x+1,239);g.setColor(2016);g.fillRect(x,lasty,x+1,v);lasty=v;x+=2;if(x>=240)x=0}
function showBPM(){var bpm=correlator.bpm();g.setColor(65504).setFontAlign(1,-1).drawString("BPM: "+bpm+" ",120,20,true)}function startMeasure(){if(interval)return;g.clear(1);g.setFont("Vector",16);x=0;HRS.enable();interval=setInterval(doread,40);bpminterval=setInterval(showBPM,2E3)}function stopMeasure(){if(interval){interval=clearInterval(interval);if(bpminterval)bpminterval=clearInterval(bpminterval);HRS.disable();g.setColor(64832).drawString("PAUSED",120,20,true)}}
TC.on("swipe",function(dir){if(dir==TC.RIGHT)startMeasure();else if(dir==TC.LEFT)stopMeasure()});E.on("kill",function(){stopMeasure()});E.showMessage("Swipe right\n to start.\n Swipe left\n to stop.","Heart Rate");